<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>施設管理画面サンプル</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: #f7f7f7;
    }
    h1, h2 {
      margin: 0;
      padding: 0;
    }
    .container {
      width: 95%;
      max-width: 1200px;
      margin: 20px auto;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 40px;
    }
    h1 {
      margin-bottom: 10px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      margin-bottom: 20px;
    }
    table th, table td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }
    .form-inline {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 10px;
      align-items: center;
    }
    .form-inline input,
    .form-inline select,
    .form-inline button {
      padding: 6px;
      font-size: 14px;
    }
    button {
      cursor: pointer;
      border-radius: 4px;
      border: none;
      background: #007bff;
      color: #fff;
      transition: background-color 0.3s;
    }
    button:hover {
      background: #0056b3;
    }
    .btn-danger {
      background: #dc3545;
    }
    .btn-danger:hover {
      background: #c82333;
    }
  </style>
</head>
<body>

  <!-- 1) 部屋在庫一覧 -->
  <div class="container" id="rooms-container">
    <h1>部屋在庫一覧</h1>
    <!-- 在庫追加フォーム -->
    <div class="form-inline">
      <input type="date" id="new-room-date" />
      <select id="new-room-category">
        <option value="standard">standard</option>
        <option value="deluxe">deluxe</option>
        <option value="suite">suite</option>
      </select>
      <input type="number" id="new-room-available" placeholder="在庫数" />
      <input type="number" id="new-room-price" placeholder="料金" />
      <button id="add-room-btn">新規追加</button>
    </div>
    <table>
      <thead>
        <tr>
          <th>日付</th>
          <th>部屋タイプ</th>
          <th>在庫数</th>
          <th>料金</th>
          <th>更新</th>
        </tr>
      </thead>
      <tbody id="rooms-list">
        <!-- Firestoreのroomsコレクションを表示 -->
      </tbody>
    </table>
  </div>

  <!-- 2) 予約管理 -->
  <div class="container" id="reservations-container">
    <h1>予約管理</h1>
    <table>
      <thead>
        <tr>
          <th>チェックイン</th>
          <th>チェックアウト</th>
          <th>部屋カテゴリー</th>
          <th>氏名</th>
          <th>電話</th>
          <th>Email</th>
          <th>人数</th>
          <th>ステータス</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody id="reservations-list">
        <!-- Firestoreのreservationsコレクションを表示 -->
      </tbody>
    </table>
  </div>

  <!-- 予約詳細編集フォーム（ポップアップ的に使用） -->
  <div class="container" id="reservation-detail" style="display:none;">
    <h2>予約詳細</h2>
    <div class="form-inline">
      <label>チェックイン: <input type="date" id="res-checkin" /></label>
      <label>チェックアウト: <input type="date" id="res-checkout" /></label>
      <label>部屋タイプ: 
        <select id="res-room-category">
          <option value="standard">standard</option>
          <option value="deluxe">deluxe</option>
          <option value="suite">suite</option>
        </select>
      </label>
    </div>
    <div class="form-inline">
      <label>氏名: <input type="text" id="res-name" /></label>
      <label>電話: <input type="text" id="res-phone" /></label>
      <label>Email: <input type="email" id="res-email" /></label>
      <label>人数: <input type="number" id="res-guests" min="1" /></label>
    </div>
    <div class="form-inline">
      <label>ステータス: 
        <select id="res-status">
          <option value="confirmed">confirmed</option>
          <option value="canceled">canceled</option>
          <option value="pending">pending</option>
        </select>
      </label>
      <button id="update-reservation-btn">更新</button>
      <button id="close-reservation-detail" class="btn-danger">閉じる</button>
    </div>
    <!-- IDを保持する隠しフィールド -->
    <input type="hidden" id="res-doc-id" />
  </div>


  <!-- 3) 顧客管理 -->
  <div class="container" id="customers-container">
    <h1>顧客管理</h1>
    <!-- 顧客新規追加フォーム -->
    <div class="form-inline">
      <input type="text" id="new-cust-name" placeholder="氏名" />
      <input type="text" id="new-cust-phone" placeholder="電話番号" />
      <input type="email" id="new-cust-email" placeholder="メールアドレス" />
      <button id="add-customer-btn">新規追加</button>
    </div>
    <table>
      <thead>
        <tr>
          <th>氏名</th>
          <th>電話</th>
          <th>Email</th>
          <th>利用回数</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody id="customers-list">
        <!-- Firestoreのcustomersコレクションを表示 -->
      </tbody>
    </table>
  </div>

  <!-- Firebase & Firestore -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import {
      getFirestore,
      collection,
      doc,
      onSnapshot,
      addDoc,
      setDoc,
      updateDoc,
      getDoc,
      runTransaction,
      serverTimestamp,
      query,
      orderBy
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

    // あなたの Firebase 設定
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT_ID.appspot.com",
      messagingSenderId: "SENDER_ID",
      appId: "APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    /*******************************************
     * 1) 部屋在庫一覧 (rooms)
     *******************************************/
    const roomsRef = collection(db, "rooms");
    const roomsListEl = document.getElementById("rooms-list");

    // リアルタイムで一覧表示
    onSnapshot(roomsRef, (snapshot) => {
      roomsListEl.innerHTML = "";
      snapshot.forEach((docSnap) => {
        const d = docSnap.data();
        const docId = docSnap.id;

        // docId 例: "2025-02-10_standard"
        // fields: { date: "2025-02-10", roomCategory: "standard", available: 5, price: 5000, ... }

        const tr = document.createElement("tr");

        // インライン編集の例: inputを置いて update ボタンで setDoc
        tr.innerHTML = `
          <td>${d.date || docId}</td>
          <td>${d.roomCategory || ""}</td>
          <td>
            <input type="number" value="${d.available ?? 0}" style="width:60px" id="available-${docId}"/>
          </td>
          <td>
            <input type="number" value="${d.price ?? 0}" style="width:80px" id="price-${docId}"/>
          </td>
          <td>
            <button data-id="${docId}" class="update-room-btn">更新</button>
          </td>
        `;
        roomsListEl.appendChild(tr);
      });

      // 更新ボタンにイベント付与
      document.querySelectorAll(".update-room-btn").forEach((btn) => {
        btn.addEventListener("click", async (e) => {
          const docId = e.currentTarget.getAttribute("data-id");
          const availInput = document.getElementById(`available-${docId}`);
          const priceInput = document.getElementById(`price-${docId}`);

          const newAvail = Number(availInput.value);
          const newPrice = Number(priceInput.value);
          
          const roomDoc = doc(db, "rooms", docId);
          await updateDoc(roomDoc, {
            available: newAvail,
            price: newPrice
          });
          alert("在庫を更新しました: " + docId);
        });
      });
    });

    // 在庫の新規追加
    document.getElementById("add-room-btn").addEventListener("click", async () => {
      const dateVal = document.getElementById("new-room-date").value; // "2025-02-10"
      const categoryVal = document.getElementById("new-room-category").value; // "standard"
      const availVal = Number(document.getElementById("new-room-available").value);
      const priceVal = Number(document.getElementById("new-room-price").value);

      if (!dateVal || !categoryVal) {
        alert("日付と部屋タイプを入力してください");
        return;
      }
      const docId = `${dateVal}_${categoryVal}`;
      const roomDoc = doc(db, "rooms", docId);
      await setDoc(roomDoc, {
        date: dateVal,
        roomCategory: categoryVal,
        available: availVal,
        price: priceVal
      });
      alert("在庫を追加/上書きしました");
    });


    /*******************************************
     * 2) 予約管理 (reservations)
     *******************************************/
    const reservationsRef = collection(db, "reservations");
    const reservationsListEl = document.getElementById("reservations-list");

    onSnapshot(
      query(reservationsRef, orderBy("createdAt","desc")),
      (snapshot) => {
        reservationsListEl.innerHTML = "";
        snapshot.forEach((docSnap) => {
          const r = docSnap.data();
          const docId = docSnap.id;
          const tr = document.createElement("tr");

          // ステータスは r.status がなければ 'confirmed' 扱いなど
          const status = r.status || 'confirmed';

          tr.innerHTML = `
            <td>${r.checkInDate || ""}</td>
            <td>${r.checkOutDate || ""}</td>
            <td>${r.roomCategory || ""}</td>
            <td>${r.name || ""}</td>
            <td>${r.phone || ""}</td>
            <td>${r.email || ""}</td>
            <td>${r.guests || ""}</td>
            <td>${status}</td>
            <td>
              <button class="edit-res-btn" data-id="${docId}">編集</button>
              <button class="cancel-res-btn btn-danger" data-id="${docId}">キャンセル</button>
            </td>
          `;
          reservationsListEl.appendChild(tr);
        });

        // 予約編集ボタン
        document.querySelectorAll(".edit-res-btn").forEach((btn) => {
          btn.addEventListener("click", async (e) => {
            const docId = e.currentTarget.getAttribute("data-id");
            await openReservationDetail(docId);
          });
        });

        // キャンセルボタン
        document.querySelectorAll(".cancel-res-btn").forEach((btn) => {
          btn.addEventListener("click", async (e) => {
            const docId = e.currentTarget.getAttribute("data-id");
            const confirmCancel = confirm("本当にキャンセルしますか？");
            if (!confirmCancel) return;

            // キャンセル → ステータスを "canceled" に変更
            // かつ在庫を戻す処理
            await cancelReservationWithInventoryReturn(docId);
          });
        });
      }
    );

    // 予約の詳細を表示し編集できるフォーム
    async function openReservationDetail(docId) {
      // 予約情報を取得
      const docRef = doc(db, "reservations", docId);
      const snap = await getDoc(docRef);
      if (!snap.exists()) {
        alert("予約が存在しません: " + docId);
        return;
      }
      const r = snap.data();

      // フォームにセット
      document.getElementById("res-checkin").value = r.checkInDate || "";
      document.getElementById("res-checkout").value = r.checkOutDate || "";
      document.getElementById("res-room-category").value = r.roomCategory || "standard";
      document.getElementById("res-name").value = r.name || "";
      document.getElementById("res-phone").value = r.phone || "";
      document.getElementById("res-email").value = r.email || "";
      document.getElementById("res-guests").value = r.guests || 1;
      document.getElementById("res-status").value = r.status || "confirmed";
      document.getElementById("res-doc-id").value = docId;

      document.getElementById("reservation-detail").style.display = "block";
    }

    // 更新ボタン
    document.getElementById("update-reservation-btn").addEventListener("click", async () => {
      const docId = document.getElementById("res-doc-id").value;
      const checkin = document.getElementById("res-checkin").value;
      const checkout = document.getElementById("res-checkout").value;
      const category = document.getElementById("res-room-category").value;
      const name = document.getElementById("res-name").value;
      const phone = document.getElementById("res-phone").value;
      const email = document.getElementById("res-email").value;
      const guests = Number(document.getElementById("res-guests").value);
      const status = document.getElementById("res-status").value;

      if (!docId) {
        alert("docIdがありません");
        return;
      }
      const resDoc = doc(db, "reservations", docId);
      await updateDoc(resDoc, {
        checkInDate: checkin,
        checkOutDate: checkout,
        roomCategory: category,
        name,
        phone,
        email,
        guests,
        status
      });
      alert("予約を更新しました");
    });

    // 詳細閉じる
    document.getElementById("close-reservation-detail").addEventListener("click", () => {
      document.getElementById("reservation-detail").style.display = "none";
    });

    // キャンセル時に在庫を戻すサンプル (単日)
    async function cancelReservationWithInventoryReturn(resId) {
      const resDocRef = doc(db, "reservations", resId);
      await runTransaction(db, async (transaction) => {
        const resSnap = await transaction.get(resDocRef);
        if (!resSnap.exists()) throw new Error("予約が存在しません");
        const r = resSnap.data();
        // 予約のステータスをキャンセルに
        if (r.status === "canceled") {
          throw new Error("既にキャンセル済みです");
        }

        // 例: "2025-02-10_standard" などのroomsドキュメントIDを仮定
        // 実際にはチェックイン～チェックアウトの全日程分を処理する必要がある場合も
        const docId = `${r.checkInDate}_${r.roomCategory}`;
        const roomRef = doc(db, "rooms", docId);
        const roomSnap = await transaction.get(roomRef);
        if (roomSnap.exists()) {
          const roomData = roomSnap.data();
          // 在庫を1戻す (単に1増やすと想定)
          const newAvail = (roomData.available || 0) + 1;
          transaction.update(roomRef, {
            available: newAvail
          });
        }

        // reservations の status を canceled に
        transaction.update(resDocRef, {
          status: "canceled"
        });
      });
      alert("予約をキャンセルしました(在庫を1戻しました)");
    }


    /*******************************************
     * 3) 顧客管理 (customers)
     *******************************************/
    const customersRef = collection(db, "customers");
    const customersListEl = document.getElementById("customers-list");

    onSnapshot(customersRef, (snapshot) => {
      customersListEl.innerHTML = "";
      snapshot.forEach((docSnap) => {
        const c = docSnap.data();
        const docId = docSnap.id;

        // c.name, c.phone, c.email, c.visitCount
        const visitCount = c.visitCount ?? 0;
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>
            <input type="text" value="${c.name || ""}" id="cust-name-${docId}" />
          </td>
          <td>
            <input type="text" value="${c.phone || ""}" id="cust-phone-${docId}" />
          </td>
          <td>
            <input type="email" value="${c.email || ""}" id="cust-email-${docId}" />
          </td>
          <td>
            <input type="number" value="${visitCount}" id="cust-visit-${docId}" style="width:60px"/>
          </td>
          <td>
            <button class="update-cust-btn" data-id="${docId}">更新</button>
          </td>
        `;
        customersListEl.appendChild(tr);
      });

      // 更新ボタン
      document.querySelectorAll(".update-cust-btn").forEach((btn) => {
        btn.addEventListener("click", async (e) => {
          const docId = e.currentTarget.getAttribute("data-id");
          const nameVal = document.getElementById(`cust-name-${docId}`).value;
          const phoneVal = document.getElementById(`cust-phone-${docId}`).value;
          const emailVal = document.getElementById(`cust-email-${docId}`).value;
          const visitVal = Number(document.getElementById(`cust-visit-${docId}`).value);

          const custDoc = doc(db, "customers", docId);
          await updateDoc(custDoc, {
            name: nameVal,
            phone: phoneVal,
            email: emailVal,
            visitCount: visitVal
          });
          alert("顧客情報を更新しました: " + docId);
        });
      });
    });

    // 新規追加
    document.getElementById("add-customer-btn").addEventListener("click", async () => {
      const nameVal = document.getElementById("new-cust-name").value;
      const phoneVal = document.getElementById("new-cust-phone").value;
      const emailVal = document.getElementById("new-cust-email").value;

      if (!nameVal) {
        alert("氏名は必須です");
        return;
      }
      await addDoc(customersRef, {
        name: nameVal,
        phone: phoneVal,
        email: emailVal,
        visitCount: 0,
        createdAt: serverTimestamp()
      });
      alert("新規顧客を追加しました");
    });
  </script>
</body>
</html>
