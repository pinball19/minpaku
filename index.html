<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>デモ：カレンダー＋予約＋予約台帳＋在庫</title>
  <style>
    /* 簡易的なスタイル例 */
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      background: #f7faff;
    }
    .container {
      width: 90%;
      max-width: 1200px;
      margin: 20px auto;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
    }
    h2 {
      margin-top: 0;
    }
    /* テーブル */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }
    table th, table td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }
    /* カレンダー用(既存のCSSやメディアクエリは割愛・簡略) */
    .calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
      margin-bottom: 20px;
    }
    .day-cell {
      border: 1px solid #ccc;
      padding: 5px;
      cursor: pointer;
      text-align: center;
    }
    .unavailable {
      background-color: #ffe2e2;
    }
  </style>
</head>
<body>
<div class="container">
  <h1>デモ：カレンダー＋予約登録＋予約台帳＋在庫</h1>

  <!-- カレンダー表示 (ざっくりとした例) -->
  <h2>カレンダー</h2>
  <div id="calendar" class="calendar"></div>

  <!-- 予約フォーム -->
  <h2>予約フォーム</h2>
  <form id="reservation-form">
    <label>チェックイン日: <input type="date" id="checkInDate" required></label><br><br>
    <label>チェックアウト日: <input type="date" id="checkOutDate" required></label><br><br>
    <label>部屋タイプ:
      <select id="roomCategory" required>
        <option value="">選択してください</option>
        <option value="standard">Standard</option>
        <option value="deluxe">Deluxe</option>
      </select>
    </label><br><br>
    <label>氏名: <input type="text" id="name" required></label><br><br>
    <label>電話番号: <input type="text" id="phone" required></label><br><br>
    <label>メールアドレス: <input type="email" id="email" required></label><br><br>
    <label>宿泊人数: <input type="number" id="guests" min="1" required></label><br><br>

    <button type="submit">予約登録</button>
  </form>

  <!-- 予約台帳 -->
  <h2>予約台帳</h2>
  <table>
    <thead>
      <tr>
        <th>チェックイン</th>
        <th>チェックアウト</th>
        <th>部屋タイプ</th>
        <th>氏名</th>
        <th>電話番号</th>
        <th>メールアドレス</th>
        <th>人数</th>
      </tr>
    </thead>
    <tbody id="reservation-list">
      <!-- Firestore上のreservationsコレクションを表示 -->
    </tbody>
  </table>

  <!-- 部屋在庫 -->
  <h2>部屋在庫一覧</h2>
  <table>
    <thead>
      <tr>
        <th>日付</th>
        <th>部屋タイプ</th>
        <th>残在庫</th>
      </tr>
    </thead>
    <tbody id="rooms-list">
      <!-- Firestore上のroomsコレクションを表示 -->
    </tbody>
  </table>
</div>

<!-- Firebase SDK (Modular) をCDNから読み込む例 -->
<script type="module">
  // ↓ 実際にはバージョンを指定してください（例: v9.22.2）
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import {
    getFirestore,
    collection,
    doc,
    onSnapshot,
    setDoc,
    runTransaction,
    serverTimestamp,
    query,
    orderBy,
    addDoc
  } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

  // あなたのFirebaseプロジェクト設定を貼り付け
    const firebaseConfig = {
      apiKey: "AIzaSyCnRbmcPezD4Osisss6XebmU15ukBqttQw",
      authDomain: "slack-bot-firebase-7991a.firebaseapp.com",
      projectId: "slack-bot-firebase-7991a",
      storageBucket: "slack-bot-firebase-7991a.firebasestorage.app",
      messagingSenderId: "215585745043",
      appId: "1:215585745043:web:0c70ac99c5066b56cd4566"
    };

  // Firebase初期化
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // ========================
  //  カレンダー(デモ用簡易版)
  // ========================
  const calendarEl = document.getElementById('calendar');
  // 例として「今月の日数分のセル」をざっくり表示するだけ
  // 本格的には前回のコードのようにループで日数生成してください
  for (let day = 1; day <= 31; day++) {
    const cell = document.createElement('div');
    cell.className = 'day-cell';
    cell.textContent = `2/${day}`;
    // ここではデモ用に在庫や予約ロジックは実装せず
    calendarEl.appendChild(cell);
  }

  // ========================
  //  予約登録
  // ========================
  const reservationForm = document.getElementById('reservation-form');
  reservationForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    // 入力情報を取得
    const checkInDate = document.getElementById('checkInDate').value;
    const checkOutDate = document.getElementById('checkOutDate').value;
    const roomCategory = document.getElementById('roomCategory').value;
    const name = document.getElementById('name').value;
    const phone = document.getElementById('phone').value;
    const email = document.getElementById('email').value;
    const guests = parseInt(document.getElementById('guests').value, 10);

    if (!checkInDate || !checkOutDate || !roomCategory) {
      alert('必須項目を入力してください');
      return;
    }

    // 例：checkInDateの日付在庫を1減らす（本当はチェックイン日～チェックアウト日の全日程分を減らすなど、要件に応じ実装）
    const docId = `${checkInDate}_${roomCategory}`; // 例: "2025-02-10_standard"
    const roomsRef = doc(db, "rooms", docId);
    const reservationsRef = collection(db, "reservations");

    try {
      await runTransaction(db, async (transaction) => {
        // 在庫ドキュメントを取得（存在しない場合は初期値など用意も必要）
        const roomSnap = await transaction.get(roomsRef);
        if (!roomSnap.exists()) {
          throw new Error("在庫データが存在しません");
        }

        const roomData = roomSnap.data();
        if (roomData.available <= 0) {
          throw new Error("在庫がありません");
        }
        // 在庫を1つ減らす
        transaction.update(roomsRef, {
          available: roomData.available - 1
        });

        // reservationsに追加
        const newReservation = {
          checkInDate,
          checkOutDate,
          roomCategory,
          name,
          phone,
          email,
          guests,
          createdAt: serverTimestamp()
        };
        // 自動IDで新規追加
        await addDoc(reservationsRef, newReservation);
      });

      alert('予約が登録されました');
      reservationForm.reset();
    } catch (err) {
      alert('予約登録中にエラー: ' + err.message);
      console.error(err);
    }
  });

  // ========================
  //  予約台帳 (reservations)
  // ========================
  const reservationListTbody = document.getElementById('reservation-list');
  // onSnapshotでリアルタイムに一覧表示
  const qReservations = query(
    collection(db, "reservations"),
    orderBy("createdAt", "desc") // 新しい順に表示など
  );
  onSnapshot(qReservations, (snapshot) => {
    reservationListTbody.innerHTML = "";
    snapshot.forEach((docSnap) => {
      const r = docSnap.data();
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.checkInDate || ""}</td>
        <td>${r.checkOutDate || ""}</td>
        <td>${r.roomCategory || ""}</td>
        <td>${r.name || ""}</td>
        <td>${r.phone || ""}</td>
        <td>${r.email || ""}</td>
        <td>${r.guests || ""}</td>
      `;
      reservationListTbody.appendChild(tr);
    });
  });

  // ========================
  //  部屋在庫 (rooms)
  // ========================
  const roomsListTbody = document.getElementById('rooms-list');
  // onSnapshotでリアルタイムに一覧表示
  const qRooms = collection(db, "rooms");
  onSnapshot(qRooms, (snapshot) => {
    roomsListTbody.innerHTML = "";
    snapshot.forEach((docSnap) => {
      const d = docSnap.data();
      // docSnap.id は "2025-02-10_standard" のような形かもしれません
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${d.date || docSnap.id}</td>
        <td>${d.roomCategory || ""}</td>
        <td>${d.available !== undefined ? d.available : ""}</td>
      `;
      roomsListTbody.appendChild(tr);
    });
  });
</script>
</body>
</html>
